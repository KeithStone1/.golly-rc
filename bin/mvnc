#!/bin/bash

RESET="\e[0m"

BLACK="\e[0;30m"
RED="\e[0;31m"
GREEN="\e[0;32m"
YELLOW="\e[0;33m"
BLUE="\e[0;34m"
MAGENTA="\e[0;35m"
CYAN="\e[0;36m"
WHITE="\e[0;37m"

B_BLACK="\e[1;30m"
B_RED="\e[1;31m"
B_GREEN="\e[1;32m"
B_YELLOW="\e[1;33m"
B_BLUE="\e[1;34m"
B_MAGENTA="\e[1;35m"
B_CYAN="\e[1;36m"
B_WHITE="\e[1;37m"

TEST_PASS="${GREEN}"
TEST_FAILURE="${B_YELLOW}"
TEST_ERROR="${B_RED}"

clear
mvn "$@" \
  | perl -pe "
    s/(?<=\[INFO\] )(?=Building )/${B_MAGENTA}/;
    s/(?<=\[INFO\] )(--- )(\S+?)(:\S+?:)(\S+?)( \()(.+?)(\).* ---)$/$MAGENTA\1$B_MAGENTA\2$MAGENTA\3$B_MAGENTA\4$MAGENTA\5$CYAN\6$MAGENTA\7/;
    s/(\[WARNING\].*)$/${YELLOW}\1/;
    s/(?<=\[INFO\] )(?=BUILD SUCCESS)/${GREEN}/;
    s/(?<=\[INFO\] )(?=BUILD FAILURE)/${RED}/;

    s/(?<=^Tests run: )(\d{2,}|[1-9])/${TEST_PASS}\1${RESET}/;

    s/(?<=, Failures: )(\d{2,}|[1-9])/${TEST_FAILURE}\1${RESET}/;
    s/^(?!Tests run: )(.+ <<< FAILURE!)$/${TEST_FAILURE}\1/;
    s/^(Failed tests:)/${TEST_FAILURE}\1${RESET}/;

    s/(?<=, Errors: )(\d{2,}|[1-9])/${TEST_ERROR}\1${RESET}/;
    s/^(?!Tests run: )(.+ <<< ERROR!)$/${TEST_ERROR}\1/;
    s/^(Tests in error:)/${TEST_ERROR}\1${RESET}/;

    s/^\[ERROR\]\s*$//;
    s/^\[ERROR\] To see the full stack trace of the errors, re-run Maven with the -e switch.[\r\n]+$//;
    s/^\[ERROR\] Re-run Maven using the -X switch to enable full debug logging.[\r\n]+$//;
    s/^\[ERROR\] For more information about the errors and possible solutions, please read the following articles:[\r\n]+$//;
    s/^\[ERROR\] -> .Help .*[\r\n]+$//;
    s@^\[ERROR\] .Help .. http://cwiki.apache.org/.*[\r\n]+\$@@;
    s/(\[ERROR\].*)$/${RED}\1/;

    s/$/${RESET}/;
  "
